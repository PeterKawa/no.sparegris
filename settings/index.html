<!DOCTYPE html>
<html>

  <head>
    <!-- The '/homey.js' script must be included in your settings view to work -->
    <script type="text/javascript" src="/homey.js" data-origin="settings"></script>
    <script type="text/javascript" src="./constants.js" data-origin="settings"></script>
    <script type="text/javascript" src="./devices.js" data-origin="settings"></script>
    <link href="style.css" rel="stylesheet" type="text/css">
    <script type="text/javascript">

      // Text strings that must be fetched from homey
      var deltaText = "settings.price.delta";
      var actionText = "settings.price.action";
      var deviceText = "settings.mode.device";
      var turnOnText = "settings.price.turnOn";
      var turnOffText = "settings.price.turnOff";
      var minTempText = "settings.frost.minTemp";
      var priorityText = "settings.mode.priority";
      var alwaysOnText = "settings.mode.alwaysOn";
      var priceLowText = "settings.price.actionLow";
      var alwaysOffText = "settings.mode.alwaysOff";
      var priceHighText = "settings.price.actionHigh";
      var priceExtremeText = "settings.price.actionExtreme";
      var deltaTempText = "settings.price.deltaTemp";
      var emergencyOffText = "settings.price.emergencyOff";
      var ignoreText = "settings.price.ignore";
      var targetTempText = "settings.mode.targetTemp";
      var controlledText = "settings.mode.controlled";
      var priceNormalText = "settings.price.actionNormal";
      var leavePageText = "settings.alert.leavepage";
      var zoneNameText = "settings.zone.zoneName";
      var zoneNumText = "settings.zone.zoneNum";
      var helpButtons = "settings.price.buttons.help";
      var helpButtonOn = "settings.price.buttons.helpOn";
      var helpButtonOff = "settings.price.buttons.helpOff";
      var helpButtonDelta = "settings.price.buttons.helpDelta";
      var helpButtonEmergency = "settings.price.buttons.helpEmergency";
      var helpButtonIgnore = "settings.price.buttons.helpIgnore";
      var timeoutText = "warnings.timeout";
      var energyFlowRateText = "settings.welcome.taskEnergyFlowRate";
      var experimentalText = "settings.welcome.taskExperimental";
      var onGoingText = "settings.help.ongoing";

      const KEEP = -1;
      const ALWAYS_OFF = 0;
      const ALWAYS_ON = 1;
      const CONTROLLED = 2;

      const TURN_ON = 0;
      const TURN_OFF = 1;
      const DELTA_TEMP = 2;
      const EMERGENCY_OFF = 3;
      const IGNORE = 4;

      const MAXLEN_DEVICETEXT = 12

      var deviceList = {
        id_a: { name:"DeviceNamenamenamenamename 1", room: "Stue",    image: "https://as2.ftcdn.net/v2/jpg/02/49/76/93/1000_F_249769389_7su5tYXOvcjcehNCcWTwcjnHvSMkLocJ.jpg", use: true, priority: 0, thermostat_cap: true, driverId: 'no.thermofloor:TF_Thermostat' },
        id_b: { name:"DeviceName 2", room: "Kjøkken", image: "https://as2.ftcdn.net/v2/jpg/02/49/76/93/1000_F_249769389_7su5tYXOvcjcehNCcWTwcjnHvSMkLocJ.jpg", use: true, priority: 1, thermostat_cap: true, driverId: 'no.thermofloor:Z-TRM2fx' },
        id_c: { name:"DeviceName 3", room: "Bad",     image: "https://as2.ftcdn.net/v2/jpg/02/49/76/93/1000_F_249769389_7su5tYXOvcjcehNCcWTwcjnHvSMkLocJ.jpg", use: true, priority: 0, thermostat_cap: false, driverId: 'default_switch' },
        id_d: { name:"DeviceName 4", room: "Bad",     image: "https://as2.ftcdn.net/v2/jpg/02/49/76/93/1000_F_249769389_7su5tYXOvcjcehNCcWTwcjnHvSMkLocJ.jpg", use: false, priority: 1, thermostat_cap: true, driverId: 'unsupported' }
      }
      // The modelist is not indexed by id because it uses the index to sort the list
      var modeList = [
        // Normal
        [ { id: "id_a", operation: CONTROLLED, targetTemp: 24 },
          { id: "id_b", operation: ALWAYS_OFF, targetTemp: 15 },
          { id: "id_c", operation: CONTROLLED, targetTemp: 20 },
          { id: "id_d", operation: CONTROLLED, targetTemp: 20 }
        ],
        [], // Night
        [], // Away
        []  // Custom
      ]
      var frostList = {} // Indexed by deviceId
      var zoneList = {} // Indexed by zone-id
      var priceActionList = [ {}, {}, {}, {} ] // Indexed by deviceId
      var currentPricePoint = 1; // Normal
      var currentOperatingMode = 0; // Disabled
      var currentErrorMargin = 5;
      var currentfreeThreshold = 100;
      var currentSafetyPower = 500;
      var currentMainFuse = 63;
      var futurePriceOptions = {};
      var appConfigProgress = {ApiStatus:0};
      var currentModeTab = 0; // Normal

      var pricePoints = [
        { name:"settings.pricetab.cheap", value: 0 },
        { name:"settings.pricetab.normal", value: 1 },
        { name:"settings.pricetab.expensive", value: 2 },
        { name:"settings.pricetab.extreme", value: 3 }
      ]

      function limitText(text) {
        const splitText = text.split(" ", 5);
        for (let i = 0; i < splitText.length; i++) {
          if (splitText[i].length > MAXLEN_DEVICETEXT) {
            let firstPart = splitText[i].substring(0,MAXLEN_DEVICETEXT);
            let secondPart = splitText[i].substring(MAXLEN_DEVICETEXT);
            splitText.splice(i, 1, firstPart);
            splitText.splice(i+1, 0, secondPart);
            console.log(`${splitText}`);
            if (splitText.length > 5) {
              splitText.pop();
            }
          }
        }
        return splitText.join(" ")
      }

      function generateEnableList(listName, priority) {
        var list = document.getElementById(listName);
        var gen_list = "<table class=device-list>";
        let found_experimental_on = false;
        let experimentalId = 'experimental' + priority;
        for (var key in deviceList) {
          var device = deviceList[key];
          if (device.priority != priority)
            continue;
          let experimental = !(device.driverId in DEVICE_CMD) || ("beta" in DEVICE_CMD[device.driverId]);
          found_experimental_on |= device.use && experimental;
          let enabledImg = device.use ? experimental ? "experimental.png" : "enabled.png" : "disabled.png";
          let experimentalCmd = experimental ? 'document.getElementById(\'' + experimentalId + '\').style.display=\'block\';' : '';
          gen_list +=
            '<tr>' +
            '  <td><img src="' + device.image + '" alt="icon"></td>' +
            '  <td><input type="image" width="40" height="20" src="' + enabledImg + '" onclick="' + experimentalCmd + 'toggleEnableDevice(event, \'' + String(key) + '\');displaySaveHint()" id="enableDevice' + String(key) + '"></td>' +
            '  <td><h3>' + limitText(device.name) + '</h3></td>' +
            '  <td><p>' + device.room + '</p></td>' +
            '</tr>';
        }
        gen_list += "</table>";
        gen_list += '<div id="' + experimentalId + '" style="display:' + (found_experimental_on?'block':'none') + ';">' + experimentalText + '</div>';
        list.innerHTML = gen_list;
      }
      
      function toggleEnableDevice(event, device_id) {
        var button = document.getElementById('enableDevice' + String(device_id))
        deviceList[device_id].use ^= true;
        var experimental = !(deviceList[device_id].driverId in DEVICE_CMD) || ("beta" in DEVICE_CMD[deviceList[device_id].driverId]);
        button.src = deviceList[device_id].use ? experimental ? "experimental.png" : "enabled.png" : "disabled.png";
      }

      function updateOperatingModes(selectedMode) {
        var list = document.getElementById("operatingMode");
        var appEn = document.getElementById("appEnabled");
        var options = '';
        if (selectedMode === 0) {
          appEn.value = 0;
          list.value = 1;
        } else {
          appEn.value = 1;
          list.value = selectedMode;
        }
      }

      function updatePricePoints(selectedPoint) {
        var list = document.getElementById("pricePoint");
        var options = '';
        for (var i = 0; i < pricePoints.length; i++) {
          options += '<option value="' + pricePoints[i].value + '" ' 
            + ((selectedPoint==i) ? 'selected' : '') + '>' + pricePoints[i].name + '</option>';
        }
        list.innerHTML = options;
      }

      function generateFrostList() {
        var list = document.getElementById("frostList");
        var gen_list =
          '<table class="device-list">' +
            '<tr>' +
              '<th>&nbsp;</th>' +
              '<th align="left" colspan="2">' + minTempText + '</th>' +
            '</tr>';
        for (var deviceId in frostList) {
          var device = deviceList[deviceId]; // refreshFrostList already called, so indexing by deviceId is safe
          var frost_temp_input = device.thermostat_cap ? '<input type="number" id="minTemp' + String(deviceId) + '" min=0 max=90 size="4" onchange="setFrostTemp(this, \'' + String(deviceId) + '\');displaySaveHint()" value="' + String(frostList[deviceId].minTemp) + '">°C' : '-';
          gen_list +=
            '<tr>' +
              '<td><img src="' + device.image + '" alt="icon" width="auto" height="50"></td>' +
              '<td><h3>' + limitText(device.name) + '</h3>' +
                '<p>' + device.room + '</p></td>' +
              '<td>' + frost_temp_input + '</td>' +
            '</tr>';
        }
        gen_list += "</table>";
        list.innerHTML = gen_list;
      }

      function generateZoneList() {
        var list = document.getElementById("zoneList");
        var gen_list =
          '<table width="100%">' +
            '<tr>' +
              '<th style="text-align:left" width="60%">' + zoneNameText + '</th>' +
              '<th style="text-align:left" width="40%">' + zoneNumText + '</th>' +
            '</tr>';
        for (zone in zoneList) {
          if (zoneList[zone].enabled === false) {
            var num_affected_devices = 0;
            for (deviceId in deviceList) {
              if (deviceList[deviceId].use && deviceList[deviceId].memberOf.includes(zone)) {
                num_affected_devices++;
              }
            }
            gen_list +=
              "<tr>" +
                "<td>" + limitText(zoneList[zone].name) + "</td>" +
                "<td>" + String(num_affected_devices) + "</td>" +
              "</tr>";
          } // else the zone has been enabled again
        }
        gen_list += '</table>';
        list.innerHTML = gen_list;
      }

      function clearZones() {
        zoneList = {};
        generateZoneList();
      }

      function generatePriceActionList(tabPage) {
        // Generate page
        var legendText = "";
        switch (tabPage) {
          case 0: legendText = priceLowText; break;
          case 1: legendText = priceNormalText; break;
          case 2: legendText = priceHighText; break;
          case 3: legendText = priceExtremeText; break;
        }
        var displayTemp = document.getElementById("controlTemp").value == 1;
        var priceTabText =
          '<fieldset>' +
            '<legend>' + legendText + ' <div class="hintButton" onclick="toggle(this,\'priceActionHint\');return false;">i</div></legend>' +
            '<p id="priceActionHint" class="hint">' + helpButtons + ':<br>' +
              '<span class="imgButtonText" id="demoButton1" onclick="return false;">N/A</span> ' + helpButtonOn + '<br>' +
              '<span class="imgButtonText" id="demoButton2" onclick="return false;">N/A</span> ' + helpButtonOff + '<br>' +
              '<span class="imgButtonText" id="demoButton3" onclick="return false;">N/A</span> ' + helpButtonDelta + '<br>' +
              '<span class="imgButtonText" id="demoButton4" onclick="return false;">N/A</span> ' + helpButtonEmergency + '<br>' +
              '<span class="imgButtonText" id="demoButton5" onclick="return false;">N/A</span> ' + helpButtonIgnore + '<br>' +
              '' +
              '' +
            '</p>' +
            '<table class="device-list">' +
              '<tr>' +
              '<th>&nbsp;</th>' +
              '<th align="left">' + deviceText + '</th>' +
              '<th align="left">' + actionText + '</th>' +
              (displayTemp ? `<th align="left">${deltaText}</th>` : '') +
            '</tr>';
        for (var deviceId in priceActionList[tabPage]) {
          var device = deviceList[deviceId]; // refreshPriceActionList already called so indexing by deviceId should be safe
          var price_temp_input = device.thermostat_cap ? '<input type="number" id="deltaTemp' + String(deviceId) + '" min=-30 max=30 size="4" step="0.5" onchange="setDeltaTemp(this, ' + String(tabPage) + ', \'' + String(deviceId) + '\');displaySaveHint()" value="' + String(priceActionList[tabPage][deviceId].delta) + '">°C' : '-';
          priceTabText +=
            '<tr>' +
              '<td><img src="' + device.image + '" alt="icon" width="auto" height="50"></td>' +
              '<td><h3>' + limitText(device.name) + '</h3>' +
                '<p>' + device.room + '</p></td>' +
              '<td><div class="imgButtonText" id="priceActionButton' + String(deviceId) + '" onclick="updatePriceAction(this, ' + String(tabPage) + ', \'' + String(deviceId) + '\');displaySaveHint()">N/A</div></td>' +
              (displayTemp ? `<td>${price_temp_input}</td>` : '') +
            '</tr>';
        }
        priceTabText +=
            '</table>' +
          '</fieldset>';
        document.getElementById("priceActionList").innerHTML = priceTabText;

        // Refresh states on list elements
        updatePriceAction(document.getElementById('demoButton1'), undefined, undefined, TURN_ON);
        updatePriceAction(document.getElementById('demoButton2'), undefined, undefined, TURN_OFF);
        updatePriceAction(document.getElementById('demoButton3'), undefined, undefined, DELTA_TEMP);
        updatePriceAction(document.getElementById('demoButton4'), undefined, undefined, EMERGENCY_OFF);
        updatePriceAction(document.getElementById('demoButton5'), undefined, undefined, IGNORE);
        for (var deviceId in priceActionList[tabPage]) {
          updatePriceAction(document.getElementById('priceActionButton' + String(deviceId)), tabPage, deviceId, KEEP);
        }
      }

      function generatePriorityList(listNum) {
        var displayTemp = document.getElementById("controlTemp").value == 1;
        var list = document.getElementById("priorityList");
        var gen_list =
          '<table class=device-list>' +
            '<tr>' +
              '<th colspan="3" align="left">' + priorityText + '</th>' +
              '<th align="left">' + deviceText + '</th>' +
              (displayTemp ? `<th align="left">${targetTempText}</th>` : '') +
            '</tr>';
        for (var i = 0; i < modeList[listNum].length; i++) {
          var device = deviceList[modeList[listNum][i].id]; // refreshModeLists already called so should be safe to index deviceList with modeList[listNum][i].id
          var upenabled  = (i==0) ? 'disabled' : '';
          var dwnenabled = (i==modeList[listNum].length-1) ? 'disabled' : '';
          var target_temp_input = device.thermostat_cap ? '<input type="number" id="targetTemp' + String(i) + '" min=0 max=90 step="0.5" size="4" onchange="setTargetTemp(this,' + String(listNum) + ',' + String(i) + ');displaySaveHint()" value="' + String(modeList[listNum][i].targetTemp) + '">°C' : '-';
          gen_list +=
            '<tr>' +
              '<td><input ' + upenabled + ' type="image" width="40" height="15" src="up_arrow.png" onclick="moveDevice(event, ' + String(listNum) + ', ' + String(i) + ',-1);displaySaveHint()" id="moveDeviceUp' + String(i) + '"/><br>' +
                  '<input ' + dwnenabled + ' type="image" width="40" height="15" src="down_arrow.png" onclick="moveDevice(event, ' + String(listNum) + ', ' + String(i) + ',+1);displaySaveHint()" id="moveDeviceDown' + String(i) + '"/></td>' +
              '<td><img src="' + device.image + '" alt="icon" width="auto" height="50"></td>' +
              '<td><div class="imgButtonText" id="deviceStateButton' + String(i) + '" onclick="updateState(this, ' + String(listNum) + ', ' + String(i) + ');displaySaveHint()">N/A</div></td>' +
              '<td><h3>' + limitText(device.name) + '</h3>' +
                  '<p>' + device.room + '</p></td>' +
                  (displayTemp ? `<td>${target_temp_input}</td>` : '') +
            '</tr>';
        }
        gen_list += "</table>";
        list.innerHTML = gen_list;

        // Refresh states on list elements
        for (var i = 0; i < modeList[listNum].length; i++) {
          updateState(document.getElementById('deviceStateButton' + String(i)), listNum, i, KEEP);
        }
      }

      function updatePriceAction(button, pricePoint, device_id, newstate = undefined) {
        var deltaTempInput = undefined;
        var displayTemp = document.getElementById("controlTemp").value == 1;
        if (pricePoint !== undefined) {
          if (newstate == undefined) {
            newstate = (priceActionList[pricePoint][device_id].operation + 1) % 5;
          } else if (newstate == KEEP) {
            newstate = priceActionList[pricePoint][device_id].operation;
          }
          var device = deviceList[device_id]; // refreshPriceActionList already called so should be safe to index by elements from priceActionList[tabPage]
          if (!(device.thermostat_cap && displayTemp) && newstate == DELTA_TEMP) {
            newstate = EMERGENCY_OFF;
          }
          priceActionList[pricePoint][device_id].operation = newstate;
          deltaTempInput =  document.getElementById('deltaTemp' + String(device_id));
        }
        switch (newstate) {
          case TURN_OFF:
            button.innerHTML=turnOffText;
            button.style.backgroundImage = 'radial-gradient(white, lightgray, gray)';
            if (deltaTempInput) deltaTempInput.disabled = true;
            break;
          case TURN_ON:
            button.innerHTML=turnOnText;
            button.style.backgroundImage = 'radial-gradient(white, rgb(255, 255, 150), orange)';
            if (deltaTempInput) deltaTempInput.disabled = true;
            break;
          case DELTA_TEMP:
            button.innerHTML=deltaTempText;
            button.style.backgroundImage = 'radial-gradient(white, rgb(150, 255, 150), green)';
            if (deltaTempInput) deltaTempInput.disabled = false;
            break;
          case EMERGENCY_OFF:
            button.innerHTML=emergencyOffText;
            button.style.backgroundImage = 'radial-gradient(white, rgb(150, 255, 150), green)';
            if (deltaTempInput) deltaTempInput.disabled = true;
            break;
          case IGNORE:
            button.innerHTML=ignoreText;
            button.style.backgroundImage = 'radial-gradient(white, lightgray, gray)';
            if (deltaTempInput) deltaTempInput.disabled = true;
            break;
        }
      }

      function updateState(button, listNum, device_id, newstate = undefined) {
        if (newstate == undefined) {
          newstate = (modeList[listNum][device_id].operation + 1) % 3;
        } else if (newstate == KEEP) {
          newstate = modeList[listNum][device_id].operation;
        }
        modeList[listNum][device_id].operation = newstate;
        switch (modeList[listNum][device_id].operation) {
          case ALWAYS_OFF:
            button.innerHTML=alwaysOffText;
            button.style.backgroundImage = 'radial-gradient(white, lightgray, gray)';
            break;
          case ALWAYS_ON:
            button.innerHTML=alwaysOnText;
            button.style.backgroundImage = 'radial-gradient(white, rgb(255, 150, 150), red)';
            break;
          case CONTROLLED:
            button.innerHTML=controlledText;
            button.style.backgroundImage = 'radial-gradient(white, rgb(150, 255, 150), green)';
            break;
        }
      }

      function moveDevice(event, listNum, device_id, delta) {
        if ((device_id + delta < 0) || (device_id + delta >= modeList[listNum].length)) {
          return;
        }
        var temp1 = modeList[listNum][device_id];
        var temp2 = modeList[listNum][device_id + delta];
        modeList[listNum][device_id] = temp2;
        modeList[listNum][device_id + delta] = temp1;
        generatePriorityList(listNum);
      }

      function checkPriceMode(source) {
        var priceControl = document.getElementById('priceControl');
        var priceLowerPart = document.getElementById('priceLowerPart');
        if (source.value == "1") {
          // Internal use
          priceControl.style.display = 'block';
          priceLowerPart.style.display = 'block';
        } else if (source.value == "0") {
          // External
          priceControl.style.display = 'none';
          priceLowerPart.style.display = 'block';
        } else {
          // Disabled
          priceControl.style.display = 'none';
          priceLowerPart.style.display = 'none';
        }
      }

      function toggle(source, id, type = 'block') {
        var element = document.getElementById(id);

        var visible = (element.style.display != "") && (element.style.display != "none");
        if (visible) {
          element.style.display = 'none';
          source.style.cursor = "zoom-in";
        } else {
          element.style.display = type;
          source.style.cursor = "zoom-out";
        }
      }

      function displaySaveHint() {
        var rememberToSaveElement = document.getElementById("rememberToSave");
        rememberToSaveElement.style.display = 'block';
      }

      function setMaxPower(value, min, max) {
        if(value != "") {
          if(parseInt(value) < parseInt(min)) { value = min; }
          if(parseInt(value) > parseInt(max)) { value = max; }
          document.getElementById('maxPower').value = value;
          document.getElementById('forMaxPower').value = value;
        }
      }

      function setFrostTemp(object, device_id) {
        if(object.value != ""){
          if(parseInt(object.value) < parseInt(object.min)){
            object.value = object.min;
          }
          if(parseInt(object.value) > parseInt(object.max)){
            object.value = object.max;
          }
          frostList[device_id]['minTemp'] = object.value
        }
      }

      function setDeltaTemp(object, price_point, deviceId) {
        if(object.value != ""){
          if(parseInt(object.value) < parseInt(object.min)){
            object.value = object.min;
          }
          if(parseInt(object.value) > parseInt(object.max)){
            object.value = object.max;
          }
          priceActionList[price_point][deviceId]['delta'] = object.value
        }
      }

      function setTargetTemp(object, listNum, device_id) {
        if(object.value != ""){
          if(parseInt(object.value) < parseInt(object.min)){
            object.value = object.min;
          }
          if(parseInt(object.value) > parseInt(object.max)){
            object.value = object.max;
          }
          modeList[listNum][device_id]['targetTemp'] = object.value
        }
      }

      function setVisible(id, type = 'table-row') {
        var element = document.getElementById(id);
        element.style.display = type;
      }

      function refreshTodoList() {
        let experimentalEnabled = false;
        for (var key in deviceList) {
          var device = deviceList[key];
          var experimental = !(device.driverId in DEVICE_CMD) || ("beta" in DEVICE_CMD[device.driverId]);
          experimentalEnabled |= device.use && experimental;
        }
        let appIsDisabled = (document.getElementById("appEnabled").value == '0');
        let haveTasks = false;
        if (appIsDisabled) {
          setVisible('taskEnableApp');
          haveTasks = true;
        } else {
          setVisible('taskEnableApp', 'none');
        }
        if (!appIsDisabled && appConfigProgress.energyMeterNotConnected) {
          setVisible('taskCreateEnergyFlow');
          haveTasks = true;
        } else {
          setVisible('taskCreateEnergyFlow', 'none');
        }
        if (!appIsDisabled && !appConfigProgress.energyMeterNotConnected && (+appConfigProgress.timeSinceEnergyMeter > 120)) {
          setVisible('taskEnergyFlowRate');
          haveTasks = true;
        } else {
          setVisible('taskEnergyFlowRate', 'none');
        }
        const priceMode = document.getElementById("priceMode").value;
        if (!appIsDisabled && priceMode == 0 && !appConfigProgress.gotPPFromFlow) {
          setVisible('taskNoPriceFlow');
          haveTasks = true;
        } else {
          setVisible('taskNoPriceFlow', 'none');
        }
        if (!appIsDisabled && priceMode == 1 && appConfigProgress.ApiStatus == 0) {
          setVisible('taskNoPriceAPI');
          haveTasks = true;
        } else {
          setVisible('taskNoPriceAPI', 'none');
        }
        if (!appIsDisabled && priceMode == 1 && appConfigProgress.ApiStatus == 1) {
          setVisible('taskNoPriceAPIDevice');
          haveTasks = true;
        } else {
          setVisible('taskNoPriceAPIDevice', 'none');
        }
        if (!appIsDisabled && priceMode == 1 && appConfigProgress.ApiStatus == 3) {
          setVisible('taskNoPriceAPIData');
          haveTasks = true;
        } else {
          setVisible('taskNoPriceAPIData', 'none');
        }
        if (!appIsDisabled && priceMode == 2) {
          setVisible('taskNoPriceEnabled');
          haveTasks = true;
        } else {
          setVisible('taskNoPriceEnabled', 'none');
        }
        if (document.getElementById('logLevel').value != 0) {
          setVisible('taskDisableLogging');
          haveTasks = true;
        } else {
          setVisible('taskDisableLogging', 'none');
        }
        if (experimentalEnabled) {
          setVisible('taskExperimental');
          haveTasks = true;
        } else {
          setVisible('taskExperimental', 'none');
        }
        if (!haveTasks) {
          setVisible('taskNone');
        } else {
          setVisible('taskNone', 'none');
        }
      }

      function refreshDeviceSelector(devices) {
        const devSel = document.getElementById("deviceInfoSelector");
        var selectedPoint = 0
        var options = '';
        for (var i = 0; i < devices.length; i++) {
          options += '<option value="' + devices[i].value + '" '
            + ((selectedPoint==i) ? 'selected' : '') + '>' + devices[i].name + '</option>';
        }
        devSel.innerHTML = options;
      }
    </script>
  </head>


  <body>
    <!-- 
    <h1 data-i18n="settings.title">.title</h1>
    <p data-i18n="settings.subtitle">.subtitle</p>
    -->
    <!-- Loading page-->
    <div id="loadingPage">
    <div data-i18n="settings.loadingText" id="loadingText">loadingText</div>
    <p><div data-i18n="settings.sponsoredBy" id="sponsoredByText">sponsoredBy</div></p>
    <div data-i18n="settings.sponsorText" id="sponsorText">sponsorText</div>
    </div>

    <!-- Menu -->
    <table id="main_menu" class="menu" style="display:none;top:0px;position:fixed;">
      <tbody class="menuitem">
      <tr>
        <td><a href="#home" data-i18n="settings.menu.home.title" onclick="changeTab(event, 'welcomePage')">Home</a></td>
        <td class="dropdown">
          <a href="javascript:void(0)" class="dropbtn" data-i18n="settings.menu.devices.title">Devices</a>
          <div class="dropdown-content">
            <a href="#" data-i18n="settings.menu.devices.controllable" onclick="changeTab(event, 'devicePage')">Controllable devices</a>
            <a href="#" data-i18n="settings.menu.devices.modes" onclick="changeTab(event, 'priorityPage', 0)">Modes and priority</a>
            <a href="#" data-i18n="settings.menu.devices.prices" onclick="changeTab(event, 'pricePage')">Price control</a>
          </div>
        </td>
        <td class="dropdown">
          <a href="javascript:void(0)" class="dropbtn" data-i18n="settings.menu.advanced.title">Advanced</a>
          <div class="dropdown-content">
            <a href="#" data-i18n="settings.menu.advanced.settings" onclick="changeTab(event, 'advancedPage')">Advanced settings</a>
            <a href="#" data-i18n="settings.menu.advanced.frost" onclick="changeTab(event, 'frostPage')">Frost guard</a>
            <a href="#" data-i18n="settings.menu.advanced.zones" onclick="changeTab(event, 'zonePage')">Zone control</a>
          </div>
        </td>
        <td class="dropdown" style="text-align:right">
          <a href="javascript:void(0)" class="dropbtn" data-i18n="settings.menu.help.title">Help</a>
          <div class="dropdown-content" style="position:fixed;right:0">
            <a href="#" data-i18n="settings.menu.help.save" onclick="changeTab(event, 'helpHowToPage')">How To Save Money</a>
            <a href="#" data-i18n="settings.menu.help.notfound" onclick="changeTab(event, 'helpNotFoundPage')">Not Found</a>
            <a href="#" data-i18n="settings.menu.help.charger" onclick="changeTab(event, 'helpChargerPage')">Car Chargers</a>
            <a href="#" data-i18n="settings.menu.help.supported" onclick="changeTab(event, 'helpSupportedPage')">Supported Devices</a>
            <a href="#" data-i18n="settings.menu.help.about" onclick="changeTab(event, 'helpAboutPage')">About</a>
          </div>
        </td>
      </tr>
    </tbody>
    </table>

    <div style="padding:16px;margin-top:16px;height:0px;"></div>

    <!-- Important information is shown here -->
    <div data-i18n="warnings.rememberToSave" id="rememberToSave">Remember to save</div>

    <!-- Welcome page -->
    <div id="welcomePage" class="tabcontent">
      <fieldset>
        <legend data-i18n="settings.mode.powerSettings">mode.powerSettings</legend>
        <table class="settings_table">
          <tr>
            <td class="settings_row_name"><label for="appEnabled" data-i18n="settings.app.activeted">app.activeted</label>:</td>
            <td class="settings_row_input">
              <select id="appEnabled" onchange="displaySaveHint();refreshTodoList();">
                <option value="0" selected data-i18n="settings.app.disabled">App Disabled</option>
                <option value="1" data-i18n="settings.app.enabled">App Enabled</option>
              </select>
              <div class="hintButton" onclick="toggle(this,'activationHint1');toggle(this,'activationHint2');return false;">i</div></td>
          </tr>
        </table>
        <p id="activationHint1" class="hint" data-i18n="settings.app.activationHint1">app.activationHint1</p>
        <p id="activationHint2" class="hint" data-i18n="settings.app.activationHint2">app.activationHint2</p>

        <table class="settings_table">
          <tr>
            <td class="settings_row_name"><label for="maxPower" data-i18n="settings.mode.maxPower">mode.maxPower</label>:</td>
            <td class="settings_row_input">
              <select id ="forMaxPower" onchange="setMaxPower(this.value,1000,100000);displaySaveHint();">
                <option value="2000" data-i18n="settings.mode.powerLimit1">mode.powerLimit1</option>
                <option value="5000" data-i18n="settings.mode.powerLimit2" selected>mode.powerLimit2</option>
                <option value="10000" data-i18n="settings.mode.powerLimit3">mode.powerLimit3</option>
                <option value="15000" data-i18n="settings.mode.powerLimit4">mode.powerLimit4</option>
                <option value="20000" data-i18n="settings.mode.powerLimit5">mode.powerLimit5</option>
                <option value="25000" data-i18n="settings.mode.powerLimit6">mode.powerLimit6</option>
                <option value="50000" data-i18n="settings.mode.powerLimit7">mode.powerLimit7</option>
                <option value="75000" data-i18n="settings.mode.powerLimit8">mode.powerLimit8</option>
                <option value="100000" data-i18n="settings.mode.powerLimit9">mode.powerLimit9</option>
                <option value="inf" data-i18n="settings.mode.powerLimit10">mode.powerLimit10</option>
              </select>
              <input id="maxPower" onchange="setMaxPower(this.value,1000,100000);displaySaveHint();" type="number" min="1000" max="100000" value="5000" step="100" size="8">Wh
              <div class="hintButton" onclick="toggle(this,'maxPowHint');return false;">i</div></td>
          </tr>
        </table>
        <p id="maxPowHint" class="hint" data-i18n="settings.app.maxPowHint">app.maxPowHint</p>
      </fieldset>
      <fieldset>
        <legend data-i18n="settings.app.myTasks">app.myTasks</legend>

        <table class="settings_table">
          <tr id="taskCreateEnergyFlow"><td style="vertical-align:top;"><span class="⚠ err"></span></td><td><span data-i18n="settings.welcome.taskCreateEnergyFlow">taskCreateEnergyFlow</span></td></tr>
          <tr id="taskNoPriceAPI"><td style="vertical-align:top;"><span class="⚠ err"></span></td><td><span data-i18n="settings.welcome.taskNoPriceAPI">taskNoPriceAPI</span></td></tr>
          <tr id="taskNoPriceAPIDevice"><td style="vertical-align:top;"><span class="⚠ err"></span></td><td><span data-i18n="settings.welcome.taskNoPriceAPIDevice">taskNoPriceAPIDevice</span></td></tr>
          <tr id="taskNoPriceAPIData"><td style="vertical-align:top;"><span class="⚠ err"></span></td><td><span data-i18n="settings.welcome.taskNoPriceAPIData">taskNoPriceAPIData</span></td></tr>
          <tr id="taskEnableApp"><td style="vertical-align:top;"><span class="⚠ warn"></span></td><td><span data-i18n="settings.welcome.taskEnableApp">taskEnableApp</span></td></tr>
          <tr id="taskEnergyFlowRate"><td style="vertical-align:top;"><span class="⚠ warn"></span></td><td><span id="energyFlowRateText">taskEnergyFlowRate</span></td></tr>
          <tr id="taskNoPriceFlow"><td style="vertical-align:top;"><span class="⚠ warn"></span></td><td><span data-i18n="settings.welcome.taskNoPriceFlow">taskNoPriceFlow</span></td></tr>
          <tr id="taskDisableLogging"><td style="vertical-align:top;"><span class="⚠ warn"></span></td><td><span data-i18n="settings.welcome.taskDisableLogging">taskDisableLogging</span></td></tr>
          <tr id="taskExperimental"><td style="vertical-align:top;"><span class="⚠ warn"></span></td><td><span data-i18n="settings.welcome.taskExperimental">taskExperimental</span></td></tr>
          <tr id="taskNoPriceEnabled"><td style="vertical-align:top;"><span class="⚠ info"></span></td><td><span data-i18n="settings.welcome.taskNoPriceEnabled">taskNoPriceEnabled</span></td></tr>
          <tr id="taskNone"><td style="vertical-align:top;"><span class="⚠ info"></span></td><td><span data-i18n="settings.welcome.taskNone">taskNone</span></td></tr>
        </table>

      </fieldset>
    </div>

    <!-- Help page: How to save money -->
    <div id="helpHowToPage" class="tabcontent">
      <fieldset>
        <legend data-i18n="settings.help.saveMoney">help.saveMoney</legend>
        <p data-i18n="settings.help.saveMoneyHint">help.saveMoneyHint</p>
      </fieldset>
    </div>

    <!-- Help page: How to save money -->
    <div id="helpNotFoundPage" class="tabcontent">
      <fieldset>
        <legend data-i18n="settings.help.notFound">help.notFound</legend>
        <p data-i18n="settings.help.notFoundHint">help.notFoundHint</p>
        <a href="#ShowLog" data-i18n="settings.log.show" onclick="changeTab(event, 'logPage');return false;">log.show</a>
      </fieldset>
    </div>

    <!-- Help page: Car Chargers -->
    <div id="helpChargerPage" class="tabcontent">
      <fieldset>
        <legend data-i18n="settings.help.carCharger">help.carCharger</legend>
        <p data-i18n="settings.help.carChargerHint">help.carChargerHint</p>
      </fieldset>
    </div>


    <!-- Help page: Supported Devices -->
    <div id="helpSupportedPage" class="tabcontent">
      <fieldset>
        <legend data-i18n="settings.help.supportedDevices">help.supportedDevices</legend>
        <div id="supportedDevicesList">This list should have been populated by supported devices, if you can see this text it is a bug.</div>
        <p data-i18n="settings.help.supportedDevicesHint">help.supportedDevicesHint</p>
        <a href="#ShowLog" data-i18n="settings.global.problemsolver" onclick="changeTab(event, 'helpNotFoundPage');return false;">global.problemsolver</a>
      </fieldset>
    </div>

    <!-- Help page: About -->
    <div id="helpAboutPage" class="tabcontent">
      <fieldset>
        <legend data-i18n="settings.help.aboutInfo">help.aboutInfo</legend>
        <p data-i18n="settings.help.aboutInfoHint">help.aboutInfoHint</p>
      </fieldset>
    </div>

    <!-- Advanced page -->
    <div id="advancedPage" class="tabcontent">
      <fieldset>
        <legend data-i18n="settings.global.settings">global.settings</legend>
        <table class="settings_table">
          <tr>
            <td class="settings_row_name"><label for="errorMargin" data-i18n="settings.global.errorMargin">global.errorMargin</label>:</td>
            <td class="settings_row_input"><input id="errorMargin" type="number" min="0" max="30" value="5" onchange="displaySaveHint()">% 
            <div class="hintButton" onclick="toggle(this,'hintEm1');toggle(this,'hintEm2');return false;">i</div></td>
          </tr>
        </table>
        <p id="hintEm1" class="hint" data-i18n="settings.global.errorMarginHint1">global.errorMarginHint1</p>
        <p id="hintEm2" class="hint" data-i18n="settings.global.errorMarginHint2">global.errorMarginHint2</p>

        <table class="settings_table">
          <tr>
            <td class="settings_row_name"><label for="safetyPower" data-i18n="settings.global.safetyPower">global.safetyPower</label>:</td>
            <td class="settings_row_input"><input id="safetyPower" type="number" min="0" max="100000" step="100" value="500" onchange="displaySaveHint()">W 
            <div class="hintButton" onclick="toggle(this,'hint3');toggle(this,'hint4');return false;">i</div></td>
          </tr>
        </table>
        <p id="hint3" class="hint" data-i18n="settings.global.safetyPowerHint1">global.safetyPowerHint1</p>
        <p id="hint4" class="hint" data-i18n="settings.global.safetyPowerHint2">global.safetyPowerHint2</p>

        <table class="settings_table">
          <tr>
            <td class="settings_row_name"><label for="mainFuse" data-i18n="settings.global.mainFuse">global.mainFuse</label>:</td>
            <td class="settings_row_input"><input id="mainFuse" type="number" min="0" max="100000" value="63" onchange="displaySaveHint()">A 
            <div class="hintButton" onclick="toggle(this,'mainFuseHint');return false;">i</div></td>
          </tr>
        </table>
        <p id="mainFuseHint" class="hint" data-i18n="settings.global.mainFuseHint">global.mainFuseHint</p>

        <table class="settings_table">
          <tr>
            <td class="settings_row_name"><label for="freeThreshold" data-i18n="settings.global.freeThreshold">global.freeThreshold</label>:</td>
            <td class="settings_row_input"><input id="freeThreshold" type="number" min="0" max="100" value="100" onchange="displaySaveHint()">% 
            <div class="hintButton" onclick="toggle(this,'freeThresholdHint');return false;">i</div></td>
          </tr>
        </table>
        <p id="freeThresholdHint" class="hint" data-i18n="settings.global.freeThresholdHint">global.freeThresholdHint</p>
      </fieldset>
    </div>

    <!-- Global page -->
    <div id="devicePage" class="tabcontent">
      <fieldset>
        <legend for="highPriDevices"><div class="blockHeader" data-i18n="settings.global.controllableDevices">global.controllableDevices</div> 
          <div class="hintButton" onclick="toggle(this,'hintcd1');toggle(this,'hintcd2');return false;">i</div></legend>
        <p id="hintcd1" class="hint" data-i18n="settings.global.deviceListHint1">global.deviceListHint1</p>
        <p id="hintcd2" class="hint" data-i18n="settings.global.deviceListHint2">global.deviceListHint2</p>

        <table class="settings_table">
          <tr>
            <td class="settings_row_name"><label for="controlTemp" data-i18n="settings.global.controlTemp">global.controlTemp</label>:</td>
            <td class="settings_row_input">
              <select id="controlTemp">
                <option value=0 data-i18n="settings.global.controlTempNo">global.controlTempNo</option>
                <option value=1 data-i18n="settings.global.controlTempYes" selected>global.controlTempYes</option>
              </select>
            </td>
          </tr>
          <tr>
            <td class="settings_row_name"><label data-i18n="settings.global.missing">global.missing</label>:</td>
            <td class="settings_row_input">
              <a href="#ShowLog" data-i18n="settings.global.problemsolver" onclick="changeTab(event, 'helpNotFoundPage');return false;">global.problemsolver</a>
            </td>
          </tr>
        </table>

        <span id="highPriDevices">High Priority devices should be listed here, if not it is a bug</span>
        <legend for="lowPriDevices" data-i18n="settings.lowPriDevices"><hr></legend>
        <span id="lowPriDevices">Low Priority devices should be listed here, if not it is a bug</span>
      </fieldset>
    </div>
    <!-- Global page end -->
    
    <!-- Log page -->
    <div id="logPage" class="tabcontent">
      <fieldset>
        <legend data-i18n="settings.deviceinfo.header">deviceinfo.header</legend>
        <label for="deviceFilter"><span data-i18n="settings.deviceinfo.filter">deviceinfo.filter</span>:</label>
        <select id="deviceFilter">
          <option value=0 data-i18n="settings.deviceinfo.noDevice" selected>No device</option>
          <option value=1 data-i18n="settings.deviceinfo.listedDevice">Device is not being turned on/off</option>
          <option value=2 data-i18n="settings.deviceinfo.listedTempDevice">Device does not set temperature</option>
          <option value=3 data-i18n="settings.deviceinfo.unlistedDevice">Device is not listed</option>
        </select><br>
        <label for="deviceInfoSelector"><span data-i18n="settings.deviceinfo.selector">deviceinfo.selector</span>:</label>
        <select id="deviceInfoSelector" disabled>
          <option value=0 selected>Please wait while populating</option>
        </select><br>
        <label for="showCaps"><span data-i18n="settings.deviceinfo.getinfo">deviceinfo.getinfo</span>:</label>
        <button id="showCaps" data-i18n="settings.deviceinfo.analyze" disabled>deviceinfo.analyze</button>
      </fieldset>
      <fieldset>
        <legend data-i18n="settings.log.generic">log.generic</legend>
        <button id="showPriceApi" data-i18n="settings.log.showPriceApi">log.showPriceApi</button>
        <button id="showState" data-i18n="settings.log.showState">log.showState</button>
      </fieldset>
      <fieldset>
        <legend data-i18n="settings.log.header">log.header</legend>
        <label for="logLevel"><span data-i18n="settings.log.level">log.level</span>:</label>
        <select id="logLevel">
          <option value=0 data-i18n="settings.log.error">log.error</option>
          <option value=1 data-i18n="settings.log.basic">log.basic</option>
          <option value=2 data-i18n="settings.log.full">log.full</option>
        </select>
        <p>
          <button id="clearLog" data-i18n="settings.log.clearLog">log.clearLog</button>
          <button id="sendLog" data-i18n="settings.log.sendLog">log.sendLog</button>
        </p>
          <textarea id="diagLog"></textarea>
        <a href="#ExitLog" data-i18n="settings.log.exit" onclick="changeTab(event, 'helpNotFoundPage');return false;">log.exit</a>
      </fieldset>
    </div>
    <!-- Log page end -->

    <!-- Price page -->
    <div id="pricePage" class="tabcontent">
      <fieldset>
        <legend data-i18n="settings.price.header">price.header</legend>

        <table class="settings_table">
          <tr>
            <td class="settings_row_name"><label for="priceMode" data-i18n="settings.price.priceMode">price.priceMode</label>:</td>
            <td class="settings_row_input">
              <select id="priceMode" onchange="checkPriceMode(this);displaySaveHint()">
                <option value="0" data-i18n="settings.price.mode.flow">From flows</option>
                <option value="1" data-i18n="settings.price.mode.internal">Internally</option>
                <option value="2" data-i18n="settings.price.mode.disabled" selected>Disabled</option>
              </select>
              <div class="hintButton" onclick="toggle(this,'hintp1');return false;">i</div></td>
          </tr>
        </table>
        <p id="hintp1" class="hint" data-i18n="settings.price.priceHint1">price.priceHint1</p>

        <table class="settings_table">
          <tr>
            <td class="settings_row_name"><label for="pricePoint" data-i18n="settings.price.pricePoint">price.pricePoint</label>:</td>
            <td class="settings_row_input">
              <select id="pricePoint" onchange="displaySaveHint()">
                <option value="0" selected>Price point disabled</option>
              </select>
              <div class="hintButton" onclick="toggle(this,'hintpp');return false;">i</div></td>
          </tr>
        </table>
        <p id="hintpp" class="hint" data-i18n="settings.price.pricePointHint">price.pricePointHint</p>

        <span id="priceControl" style="display: none">
          <p id="errp1" class="error" data-i18n="settings.price.priceErr1">price.priceErr1</p>

          <table class="settings_table">
            <tr>
              <td class="settings_row_name"><label for="minCheapTime" data-i18n="settings.price.internal.minCheapTime">price.internal.minCheapTime</label>:</td>
              <td class="settings_row_input">
                <input id="minCheapTime" type="number" size="10" min="0" max="10" step="1" value="4" onchange="displaySaveHint()">
                <div class="hintButton" onclick="toggle(this,'minCheapTimeHint');return false;">i</div></td>
            </tr>
          </table>
          <p id="minCheapTimeHint" class="hint" data-i18n="settings.price.internal.minCheapTimeHint">price.internal.minCheapTimeHint</p>

          <table class="settings_table">
            <tr>
              <td class="settings_row_name"><label for="minExpensiveTime" data-i18n="settings.price.internal.minExpensiveTime">price.internal.minExpensiveTime</label>:</td>
              <td class="settings_row_input">
                <input id="minExpensiveTime" type="number" size="10" min="0" max="10" step="1" value="4" onchange="displaySaveHint()">
                <div class="hintButton" onclick="toggle(this,'minExpensiveTimeHint');return false;">i</div></td>
            </tr>
          </table>
          <p id="minExpensiveTimeHint" class="hint" data-i18n="settings.price.internal.minExpensiveTimeHint">price.internal.minExpensiveTimeHint</p>

          <table class="settings_table">
            <tr>
              <td class="settings_row_name"><label for="averageTime" data-i18n="settings.price.internal.averageTime">price.internal.averageTime</label>:</td>
              <td class="settings_row_input">
                <select id="averageTime" onchange="displaySaveHint()">
                  <option value="0" data-i18n="settings.price.internal.day0" selected>price.internal.day0</option>
                  <option value="1" data-i18n="settings.price.internal.day1">price.internal.day1</option>
                  <option value="2" data-i18n="settings.price.internal.day2">price.internal.day2</option>
                  <option value="4" data-i18n="settings.price.internal.day4">price.internal.day4</option>
                  <option value="7" data-i18n="settings.price.internal.day7">price.internal.day7</option>
                  <option value="30" data-i18n="settings.price.internal.day30">price.internal.day30</option>
                </select>
                <div class="hintButton" onclick="toggle(this,'averageTimeHint');return false;">i</div></td>
            </tr>
          </table>
          <p id="averageTimeHint" class="hint" data-i18n="settings.price.internal.averageTimeHint">price.internal.averageTimeHint</p>

          <table class="settings_table">
            <tr>
              <td class="settings_row_name"><label for="lowPriceModifier" data-i18n="settings.price.internal.lowPriceModifier">price.internal.lowPriceModifier</label>:</td>
              <td class="settings_row_input">
                <input id="lowPriceModifier" data-i18n="settings.price.internal.hour1" type="number" size="10" min="-50" max="-10" value="-10" onchange="displaySaveHint()">%
                <div class="hintButton" onclick="toggle(this,'lowPriceModifierHint');return false;">i</div></td>
            </tr>
          </table>
          <p id="lowPriceModifierHint" class="hint" data-i18n="settings.price.internal.lowPriceModifierHint">price.internal.lowPriceModifierHint</p>

          <table class="settings_table">
            <tr>
              <td class="settings_row_name"><label for="highPriceModifier" data-i18n="settings.price.internal.highPriceModifier">price.internal.highPriceModifier</label>:</td>
              <td class="settings_row_input">
                <input id="highPriceModifier" data-i18n="settings.price.internal.hour1" type="number" size="10" min="1" max="100" value="10" onchange="displaySaveHint()">%
                <div class="hintButton" onclick="toggle(this,'highPriceModifierHint');return false;">i</div></td>
            </tr>
          </table>
          <p id="highPriceModifierHint" class="hint" data-i18n="settings.price.internal.highPriceModifierHint">price.internal.highPriceModifierHint</p>

          <table class="settings_table">
            <tr>
              <td class="settings_row_name"><label for="extremePriceModifier" data-i18n="settings.price.internal.extremePriceModifier">price.internal.extremePriceModifier</label>:</td>
              <td class="settings_row_input">
                <input id="extremePriceModifier" data-i18n="settings.price.internal.hour1" type="number" size="10" min="100" max="1000" value="10" onchange="displaySaveHint()">%
                <div class="hintButton" onclick="toggle(this,'extremePriceModifierHint');return false;">i</div></td>
            </tr>
          </table>
          <p id="extremePriceModifierHint" class="hint" data-i18n="settings.price.internal.extremePriceModifierHint">price.internal.extremePriceModifierHint</p>
        </span>
      </fieldset>

      <div id="priceLowerPart">
        <table width="100%" id="sub_tab_selector" class="tab">
          <tr>
            <td class="subtablinks" onclick="changePriceTab(event, 0)" id="subTabCheap">
              <span data-i18n="settings.pricetab.cheap">pricetab.cheap</span></td>
            <td class="subtablinks" onclick="changePriceTab(event, 1)" id="subTabNormal">
              <span data-i18n="settings.pricetab.normal">pricetab.normal</span></td>
            <td class="subtablinks" onclick="changePriceTab(event, 2)" id="subTabExpensive">
              <span data-i18n="settings.pricetab.expensive">pricetab.expensive</span></td>
            <td class="subtablinks" onclick="changePriceTab(event, 3)" id="subTabExtreme">
              <span data-i18n="settings.pricetab.extreme">pricetab.extreme</span></td>
          </tr>
        </table>
        <span id="priceActionList">List of devices should have been generated here, if you see this text it is a bug...</span>
      </div>
    </div>
    <!-- Price page end -->

    <!-- Frost page -->
    <div id="frostPage" class="tabcontent">
      <fieldset>
        <legend><div class="blockHeader" data-i18n="settings.frost.header">frost.header</div> 
          <div class="hintButton" onclick="toggle(this,'frostHint');return false;">i</div>
        </legend>
        <p id="frostHint" class="hint" data-i18n="settings.frost.frostHint">frost.frostHint</p>
        <span id="frostList">List of devices should have been generated here, if you see this text it is a bug...</span>
      </fieldset>
    </div>
    <!-- Frost page end -->

    <!-- Zone page -->
    <div id="zonePage" class="tabcontent">
      <fieldset>
        <legend><div class="blockHeader" data-i18n="settings.zone.header">zone.header</div> 
          <div class="hintButton" onclick="toggle(this,'zoneHint');toggle(this,'zoneHint2');return false;">i</div>
        </legend>
        <p id="zoneHint" class="hint" data-i18n="settings.zone.zoneHint">zone.zoneHint</p>
        <p id="zoneHint2" class="hint" data-i18n="settings.zone.zoneHint2">zone.zoneHint</p>
        <span data-i18n="settings.zone.zonesOff">zone.zonesOff</span>:
        <span id="zoneList">Zones should have been filled in here, if you see this text it is a bug</span>
        <button id="clear" class="right" data-i18n="settings.zone.zonesClear" onclick="clearZones();displaySaveHint();return false;">zone.zonesClear</button>
      </fieldset>
    </div>
    <!-- Zone page end -->

    <!-- Mode specific page -->
    <div id="priorityPage" class="tabcontent">
      <fieldset>
        <legend><div class="blockHeader" data-i18n="settings.mode.operatingMode">mode.operatingMode</div></legend>
        <table class="settings_table">
          <tr>
            <td class="settings_row_name"><label for="operatingMode" data-i18n="settings.mode.activeMode">mode.activeMode</label>:</td>
            <td class="settings_row_input">
              <select id="operatingMode" onchange="displaySaveHint()">
                <option value="1" data-i18n="settings.opMode.normal">Normal</option>
                <option value="2" data-i18n="settings.opMode.night">Night</option>
                <option value="3" data-i18n="settings.opMode.holiday">Holiday</option>
                <option value="4" data-i18n="settings.opMode.custom">Custom</option>
              </select>
              <div class="hintButton" onclick="toggle(this,'operatingModeHint');return false;">i</div></td>
          </tr>
        </table>
        <p id="operatingModeHint" class="hint" data-i18n="settings.mode.operatingModeHint">mode.operatingModeHint</p>
      </fieldset>

      <table width="100%" id="tab_selector" class="tab">
        <tr>
          <td class="tablinks" onclick="changeTab(event, 'priorityPage', 0)" id="normalTab">
            <span data-i18n="settings.tab.normal">tab.normal</span></td>
          <td class="tablinks" onclick="changeTab(event, 'priorityPage', 1)" id="nightTab">
            <span data-i18n="settings.tab.night">tab.night</span></td>
          <td class="tablinks" onclick="changeTab(event, 'priorityPage', 2)" id="holidayTab">
            <span data-i18n="settings.tab.holiday">tab.holiday</span></td>
          <td class="tablinks" onclick="changeTab(event, 'priorityPage', 3)" id="customTab">
            <span data-i18n="settings.tab.custom">tab.custom</span></td>
        </tr>
      </table>
  
      <fieldset>
        <legend><div class="blockHeader" data-i18n="settings.mode.priorities">mode.priorities</div> 
          <div class="hintButton" onclick="toggle(this,'hint6');toggle(this,'hint7');toggle(this,'hint8');return false;">i</div>
        </legend>
        <p id="hint6" class="hint" data-i18n="settings.mode.priorityHint1">mode.priorityHint1</p>
        <p id="hint7" class="hint" data-i18n="settings.mode.priorityHint2">mode.priorityHint2</p>
        <p id="hint8" class="hint" data-i18n="settings.mode.priorityHint3">mode.priorityHint3</p>
        <span id="priorityList">List of devices should have been generated here, if you see this text it is a bug...</span>
      </fieldset>
    </div>
    <!-- Mode specific page end -->

    <button id="save" class="right" data-i18n="settings.saveButton">.saveButton</button>

    <script type="text/javascript">

      // -- Log page -- //
      var diagLogElement = document.getElementById('diagLog');
      var logLevelElement = document.getElementById('logLevel');
      var showStateElement = document.getElementById('showState');
      var showCapsElement = document.getElementById('showCaps');
      var showPriceApiElement = document.getElementById('showPriceApi');
      var clearLogElement = document.getElementById('clearLog');
      var sendLogElement = document.getElementById('sendLog');
      var deviceFilterElement = document.getElementById('deviceFilter');
      var deviceInfoSelectorElement = document.getElementById('deviceInfoSelector');

      // Load control
      var operatingModeLoaded = false;
      var errorMarginLoaded = false;
      var controlTempLoaded = false;
      var freeThresholdLoaded = false;
      var safetyPowerLoaded = false;
      var maxPowerLoaded = false;
      var deviceListLoaded = false;
      var modeListLoaded = false;
      var priceModeLoaded = false;
      var pricePointLoaded = false;
      var priceActionListLoaded = false;
      var frostListLoaded = false;
      var zoneListLoaded = false;
      var mainFuseLoaded = false;
      var futurePriceOptionsLoaded = false;
      var appConfigProgressLoaded = false;
      var onHomeyReadyCompleted = false;

      // Called whenever things has been loaded
      function checkLoadingDone() {
        var loadElement = document.getElementById("loadingPage");
/*        loadElement.innerHTML =
          `maxPowerLoaded: ${maxPowerLoaded}<br>` +
          `deviceListLoaded: ${deviceListLoaded}<br>` +
          `modeListLoaded: ${modeListLoaded}<br>` +
          `operatingModeLoaded: ${operatingModeLoaded}<br>` +
          `errorMarginLoaded: ${errorMarginLoaded}<br>` +
          `controlTempLoaded: ${controlTempLoaded}<br>` +
          `freeThresholdLoaded: ${freeThresholdLoaded}<br>` +
          `safetyPowerLoaded: ${safetyPowerLoaded}<br>` +
          `priceModeLoaded: ${priceModeLoaded}<br>` +
          `pricePointLoaded: ${pricePointLoaded}<br>` +
          `priceActionListLoaded: ${priceActionListLoaded}<br>` +
          `frostListLoaded: ${frostListLoaded}<br>` +
          `zoneListLoaded: ${zoneListLoaded}<br>` +
          `mainFuseLoaded: ${mainFuseLoaded}<br>` +
          `futurePriceOptionsLoaded: ${futurePriceOptionsLoaded}<br>` +
          `appConfigProgressLoaded: ${appConfigProgressLoaded}<br>` +
          `onHomeyReadyCompleted: ${onHomeyReadyCompleted}<br>`;*/
        if (maxPowerLoaded
          && deviceListLoaded
          && modeListLoaded
          && operatingModeLoaded
          && errorMarginLoaded
          && controlTempLoaded
          && freeThresholdLoaded
          && safetyPowerLoaded
          && priceModeLoaded
          && pricePointLoaded
          && priceActionListLoaded
          && frostListLoaded
          && zoneListLoaded
          && mainFuseLoaded
          && futurePriceOptionsLoaded
          && appConfigProgressLoaded
          && onHomeyReadyCompleted) {
          // Update device enable list:
          generateEnableList('highPriDevices', 1);
          generateEnableList('lowPriDevices', 0);

          // Initialize state and show the welcome page:
          updateOperatingModes(currentOperatingMode);
          updatePricePoints(currentPricePoint);
          loadElement.style.display = "none";
          document.getElementById("main_menu").style.display = "table";
          document.getElementById("tab_selector").style.display = "inline-block";
          document.getElementById("save").style.display = "inline-block";
          document.getElementById("errorMargin").value = currentErrorMargin;
          document.getElementById("freeThreshold").value = currentfreeThreshold;
          document.getElementById("safetyPower").value = currentSafetyPower;
          document.getElementById("pricePoint").value = currentPricePoint;
          document.getElementById("mainFuse").value = currentMainFuse;
          document.getElementById("averageTime").value = futurePriceOptions.averageTime;
          document.getElementById("minCheapTime").value = futurePriceOptions.minCheapTime;
          document.getElementById("minExpensiveTime").value = futurePriceOptions.minExpensiveTime;
          document.getElementById("lowPriceModifier").value = futurePriceOptions.lowPriceModifier;
          document.getElementById("highPriceModifier").value = futurePriceOptions.highPriceModifier;
          document.getElementById("extremePriceModifier").value = futurePriceOptions.extremePriceModifier;
          document.getElementById("errp1").style.display = (appConfigProgress.ApiStatus != 2) ? 'inline-block' : 'none';
          document.getElementById("energyFlowRateText").innerHTML = energyFlowRateText.replace("${interval}", Math.round(appConfigProgress.timeSinceEnergyMeter / 60));
          checkPriceMode(document.getElementById("priceMode")); // not called automatically when programatically changed
          changeTab(false, 'welcomePage');
        }
      }

      // a method named 'onHomeyReady' must be present in your code
      function onHomeyReady(Homey) {

        // Tell Homey we're ready to be displayed
        Homey.ready();

        var saveElement = document.getElementById("save");
        var appEnabledElement = document.getElementById("appEnabled");
        var operatingModeElement = document.getElementById("operatingMode");
        var errorMarginElement = document.getElementById("errorMargin");
        var controlTempElement = document.getElementById("controlTemp");
        var freeThresholdElement = document.getElementById("freeThreshold");
        var safetyPowerElement = document.getElementById("safetyPower");
        var priceModeElement = document.getElementById("priceMode");
        var pricePointElement = document.getElementById("pricePoint");
        var mainFuseElement = document.getElementById("mainFuse");
        var averageTimeElement = document.getElementById("averageTime");
        var minCheapTimeElement = document.getElementById("minCheapTime");
        var minExpensiveTimeElement =  document.getElementById("minExpensiveTime");
        var lowPriceModifierElement =  document.getElementById("lowPriceModifier");
        var highPriceModifierElement =  document.getElementById("highPriceModifier");
        var extremePriceModifierElement =  document.getElementById("extremePriceModifier");
        var rememberToSaveElement = document.getElementById("rememberToSave");
        var maxPowerElement = document.getElementById("maxPower");

        // Fetch translation strings from Homey
        deltaText = Homey.__(deltaText);
        actionText = Homey.__(actionText);
        deviceText = Homey.__(deviceText);
        turnOnText = Homey.__(turnOnText);
        turnOffText = Homey.__(turnOffText);
        minTempText = Homey.__(minTempText);
        priorityText = Homey.__(priorityText);
        alwaysOnText = Homey.__(alwaysOnText);
        priceLowText = Homey.__(priceLowText);
        deltaTempText = Homey.__(deltaTempText);
        emergencyOffText = Homey.__(emergencyOffText);
        ignoreText = Homey.__(ignoreText);
        alwaysOffText = Homey.__(alwaysOffText);
        priceHighText = Homey.__(priceHighText);
        priceExtremeText = Homey.__(priceExtremeText);
        targetTempText = Homey.__(targetTempText);
        controlledText = Homey.__(controlledText);
        priceNormalText = Homey.__(priceNormalText);
        leavePageText = Homey.__(leavePageText);
        zoneNameText = Homey.__(zoneNameText);
        zoneNumText = Homey.__(zoneNumText);
        helpButtons = Homey.__(helpButtons);
        helpButtonOn = Homey.__(helpButtonOn);
        helpButtonOff = Homey.__(helpButtonOff);
        helpButtonDelta = Homey.__(helpButtonDelta);
        helpButtonEmergency = Homey.__(helpButtonEmergency);
        helpButtonIgnore = Homey.__(helpButtonIgnore);
        timeoutText = Homey.__(timeoutText);
        energyFlowRateText = Homey.__(energyFlowRateText);
        experimentalText = Homey.__(experimentalText);
        onGoingText = Homey.__(onGoingText);


        for (var i = 0; i < pricePoints.length; i++) {
          pricePoints[i].name = Homey.__(pricePoints[i].name);
        }

        // Request devicelist refresh
        Homey.api('GET', '/apiCommand?cmd=createDeviceList', null, function (err, response) {
          if (err) {
            Homey.alert(`Could not load device list (${err})`);
          } else if (Object.keys(response).length === 0) {
            Homey.alert('No controllable devices found (check help section for instructions)');
          } else {
            deviceList = response;
            deviceListLoaded = true;
            checkLoadingDone();
          }
        });

        // Refresh price data
        Homey.get("futurePriceOptions", function (err, options) {
          if (err) return Homey.alert(err);
          if (options) {
            futurePriceOptions = options;
          } else {
            futurePriceOptions = {}
          }
          if (!futurePriceOptions.hasOwnProperty("minCheapTime")) futurePriceOptions.minCheapTime = 4;
          if (!futurePriceOptions.hasOwnProperty("minExpensiveTime")) futurePriceOptions.minExpensiveTime = 4;
          if (!futurePriceOptions.hasOwnProperty("averageTime")) futurePriceOptions.averageTime = 0;
          if (!futurePriceOptions.hasOwnProperty("lowPriceModifier")) futurePriceOptions.lowPriceModifier = -10;
          if (!futurePriceOptions.hasOwnProperty("highPriceModifier")) futurePriceOptions.highPriceModifier = 10;
          if (!futurePriceOptions.hasOwnProperty("extremePriceModifier")) futurePriceOptions.extremePriceModifier = 100;
          futurePriceOptionsLoaded = true;
          checkLoadingDone();
        });

        // Refresh API configuration progress
        Homey.api('GET', '/apiCommand?cmd=getAppConfigProgress', null, function (err, options) {
          if (err) return Homey.alert(err);
          if (options) {
            appConfigProgress = options;
          } else {
            appConfigProgress = {}
          }
          if (!appConfigProgress.hasOwnProperty("gotPPFromFlow")) appConfigProgress.gotPPFromFlow = false;
          if (!appConfigProgress.hasOwnProperty("timeSinceEnergyMeter")) appConfigProgress.timeSinceEnergyMeter = Infinity;
          if (!appConfigProgress.hasOwnProperty("energyMeterNotConnected")) appConfigProgress.energyMeterNotConnected = true;
          if (!appConfigProgress.hasOwnProperty("ApiStatus")) appConfigProgress.ApiStatus = 0;
          appConfigProgressLoaded = true;
          checkLoadingDone();
        });

        // Get the mode list
        Homey.get("modeList", function (err, myModeList) {
          if (err) return Homey.alert(err);
          if (Array.isArray(myModeList)) {
            modeList = myModeList;
          } else {
            // First time called
            modeList = [
              [], // Normal
              [], // Night
              [], // Holiday
              []  // Custom
            ]
          }
          modeListLoaded = true;
          checkLoadingDone();
        })
        Homey.get("frostList", function (err, myFrostList) {
          if (err) return Homey.alert(err);
          if (myFrostList !== null) {
            frostList = myFrostList;
          } // else use defaults set from the top (this is the first time)
          frostListLoaded = true;
          checkLoadingDone();
        });
        Homey.get("zones", function (err, myZoneList) {
          if (err) return Homey.alert(err);
          if (myZoneList !== null) {
            zoneList = myZoneList;
          } // else use defaults set from the top
          zoneListLoaded = true;
          checkLoadingDone();
        })
        Homey.get("priceActionList", function (err, mypriceActionList) {
          if (err) return Homey.alert(err);
          if (mypriceActionList !== null) {
            priceActionList = mypriceActionList;
          } // else use defaults set from the top (this is the first time)
          priceActionListLoaded = true;
          checkLoadingDone();
        });
        Homey.get("maxPower", function (err, maxPower) {
          if (err) return Homey.alert(err);
          if (maxPower !== null && Number.isInteger(+maxPower)) {
            document.getElementById("maxPower").value = +maxPower;
            document.getElementById("forMaxPower").value = +maxPower;
          } // else use defaults set from the top (this is the first time)
          maxPowerLoaded = true;
          checkLoadingDone();
        });
        Homey.get("operatingMode", function (err, operatingMode) {
          if (err) return Homey.alert(err);
          if (operatingMode !== null) {
            currentOperatingMode = +operatingMode;
          } else {
            currentOperatingMode = 0;
          }
          operatingModeLoaded = true;
          checkLoadingDone();
        });
        Homey.get("priceMode", function (err, priceMode) {
          if (err) return Homey.alert(err);
          if (priceMode !== null) {
            document.getElementById("priceMode").value = +priceMode;
          } else {
            document.getElementById("priceMode").value = 2;
          }
          priceModeLoaded = true;
          checkLoadingDone();
        });
        Homey.get("pricePoint", function (err, pricePoint) {
          if (err) return Homey.alert(err);
          if (pricePoint !== null) {
            currentPricePoint = pricePoint;
          } else {
            currentPricePoint = 1; // Set to normal as default
          }
          pricePointLoaded = true;
          checkLoadingDone();
        });
        Homey.get("errorMargin", function (err, errorMargin) {
          if (err) return Homey.alert(err);
          if (errorMargin !== null) {
            currentErrorMargin = errorMargin;
          } else {
            currentErrorMargin = 5;
          }
          errorMarginLoaded = true;
          checkLoadingDone();
        });
        Homey.get("controlTemp", function (err, temp) {
          if (err) return Homey.alert(err);
          if (temp !== null) {
            document.getElementById("controlTemp").value = +temp;
          } else {
            document.getElementById("controlTemp").value = 1;
          }
          controlTempLoaded = true;
          checkLoadingDone();
        });
        Homey.get("freeThreshold", function (err, threshold) {
          if (err) return Homey.alert(err);
          if (threshold !== null) {
            currentfreeThreshold = threshold;
          } else {
            currentfreeThreshold = 100;
          }
          freeThresholdLoaded = true;
          checkLoadingDone();
        });
        Homey.get("safetyPower", function (err, safetyPower) {
          if (err) return Homey.alert(err);
          if (safetyPower !== null) {
            currentSafetyPower = safetyPower;
          } else {
            currentSafetyPower = 500;
          }
          safetyPowerLoaded = true;
          checkLoadingDone();
        });
        Homey.get("mainFuse", function (err, mainFuse) {
          if (err) return Homey.alert(err);
          if (mainFuse !== null) {
            currentMainFuse = mainFuse;
          } else {
            currentMainFuse = 63; // 63 Amps is the most common main fuse in Norway
          }
          mainFuseLoaded = true;
          checkLoadingDone();
        });
        // Refresh log data
        Homey.api('GET', '/apiCommand?cmd=getLogLevel', null, function (err, logLevel) {
          if (err || !Number.isInteger(+logLevel)) logLevel = 0;
          logLevelElement.value = logLevel;
        });
        Homey.api('GET', '/apiCommand?cmd=requestLog', null, function (err, result) {
          if (err) Homey.alert(err);
        });

        // This error function is a bit deciving because it only returns err on success
        // And this err is that all settings was saved successfully
        const errFunc = (err) => { 
          if (err) {
            rememberToSaveElement.style.display = 'none';
            Homey.alert(err.message);
          }
        }
        saveElement.addEventListener("click", function (e) {
          Homey.alert(Homey.__('warnings.savingWait'));
          try {
            // Make sure all settings are up to date:
            refreshModeLists(); // It's a pitty but the user did not even visit these pages. Probably they will do later
            refreshFrostList(); // It's a pitty but the user did not even visit these pages. Probably they will do later
            refreshPriceActionList(); // It's a pitty but the user did not even visit these pages. Probably they will do later
            if (Object.keys(frostList).length === 0) {
              Homey.alert(Homey.__('warnings.noDevices'))
            } else {
              futurePriceOptions.averageTime = averageTimeElement.value;
              futurePriceOptions.minCheapTime = minCheapTimeElement.value;
              futurePriceOptions.minExpensiveTime = minExpensiveTimeElement.value;
              futurePriceOptions.lowPriceModifier = lowPriceModifierElement.value;
              futurePriceOptions.highPriceModifier = highPriceModifierElement.value;
              futurePriceOptions.extremePriceModifier = extremePriceModifierElement.value;
              let opModeValue = (appEnabledElement.value === "1") ? operatingModeElement.value : 0
              Homey.set("futurePriceOptions", futurePriceOptions, errFunc);
              Homey.set("deviceList", deviceList, errFunc);
              Homey.set("modeList", modeList, errFunc);
              Homey.set("frostList", frostList, errFunc);
              Homey.set("zones", zoneList, errFunc);
              Homey.set("maxPower", maxPowerElement.value, errFunc);
              Homey.set("operatingMode", opModeValue, errFunc);
              Homey.set("priceMode", priceModeElement.value, errFunc);
              Homey.set("pricePoint", pricePointElement.value, errFunc);
              Homey.set("priceActionList", priceActionList, errFunc);
              Homey.set("errorMargin", errorMarginElement.value, errFunc);
              Homey.set("controlTemp", controlTempElement.value, errFunc);
              Homey.set("freeThreshold",freeThresholdElement.value, errFunc);
              Homey.set("safetyPower", safetyPowerElement.value, errFunc);
              Homey.set("mainFuse", mainFuseElement.value, errFunc);
              Homey.set("settingsSaved", "", errFunc); // On settings is only called if the settings actually changed
              Homey.set("settingsSaved", "true", errFunc); // This one will throw the message settings.alert.settingssaved on success
            }
          }
          catch (err) {
            Homey.alert(Homey.__(`warnings.savingFailed: ${err}`));
          }
        });

        // -- Log page -- //
        Homey.on('logUpdate', function (log) {
          diagLogElement.value = log;
        });

        deviceFilterElement.addEventListener('change', function (e) {
          if (+deviceFilterElement.value === 0) {
            showCapsElement.disabled = true;
            deviceInfoSelectorElement.disabled = true;
          } else {
            Homey.api('GET', `/getDevices?type=${deviceFilterElement.value}`, null, function (err, result) {
              if (err) return Homey.alert(err);
              else {
                refreshDeviceSelector(result);
                if (result.length > 0) {
                  showCapsElement.disabled = false;
                  deviceInfoSelectorElement.disabled = false;
                }
              }
            });
          }
        });

        logLevelElement.addEventListener('change', function (e) {
          Homey.api('GET', `/apiCommand?cmd=setLogLevel&logLevel=${logLevelElement.value}`, null, function (err, result) {
            if (err) return Homey.alert(err);
          });
        });

        showStateElement.addEventListener('click', function (e) {
          Homey.api('GET', '/apiCommand?cmd=logShowState', null, function (err, result) {
            if (err) return Homey.alert(err);
          });
        });

        showCapsElement.addEventListener('click', function (e) {
          const deviceId = deviceInfoSelectorElement.value;
          Homey.api('GET', `/apiCommand?cmd=logShowCaps&deviceId=${deviceId}`, null, function (err, result) {
            if (err) return Homey.alert(err);
          });
        });

        showPriceApiElement.addEventListener('click', function (e) {
          Homey.api('GET', '/apiCommand?cmd=logShowPriceApi', null, function (err, result) {
            if (err) return Homey.alert(err);
          });
        });

        clearLogElement.addEventListener('click', function (e) {
          Homey.api('GET', '/apiCommand?cmd=clearLog', null, function (err, result) {
            if (err) return Homey.alert(err);
          });
        });

        sendLogElement.addEventListener('click', function (e) {
          Homey.confirm("Send the log contents to the developer?", null, function (e, ok) {
            if (ok) {
              Homey.api('GET', '/apiCommand?cmd=sendLog', null, function (err, result) {
                if (err) return Homey.alert(err);
              });
            }
          });
        });

        setTimeout(function () {
          onHomeyReadyCompleted = true;
          checkLoadingDone();
        }, 4 * 1000);

        setTimeout(function () {
          loadElement = document.getElementById("loadingPage");
          if (loadElement.style.display !== "none") {
            loadElement.innerHTML = timeoutText;
          }
        }, 7 * 1000);
      }

      function refreshPriceActionList() {
        for (var tabPage = 0; tabPage < 4; tabPage++) {
          if (priceActionList[tabPage] === undefined) {
            priceActionList[tabPage] = {};
          }
          // Remove devices that are no longer in use.
          for (var deviceId in priceActionList[tabPage]) {
            if (!(deviceId in deviceList) || !deviceList[deviceId].use) {
              delete priceActionList[tabPage][deviceId];
            }
          }
          // Add new devices
          for (var key in deviceList) {
            if (deviceList[key].use && !(key in priceActionList[tabPage])) {
              var new_op = DELTA_TEMP;
              if (!deviceList[key].thermostat_cap) {
                switch (tabPage) {
                  case 0:
                  case 1: new_op = EMERGENCY_OFF; break;
                  case 2:
                  case 3: new_op = TURN_OFF; break;
                }
              }
              const tempChangeCheapPrice = (deviceList[key].targetTemp > 50) ? 20 : Math.round(deviceList[key].targetTemp * 3 / 24);
              const tempChangeHighPrice = (deviceList[key].targetTemp > 50) ? -10 : -Math.round(deviceList[key].targetTemp * 5 / 24);
              const tempChangeInsanePrice = (deviceList[key].targetTemp > 50) ? -30 : -Math.round(deviceList[key].targetTemp * 10 / 24);
              var new_delta = (tabPage == 0) ? tempChangeCheapPrice
                : (tabPage == 1) ?  0
                : (tabPage == 2) ? tempChangeHighPrice
                : tempChangeInsanePrice;
              priceActionList[tabPage][key] = { delta: new_delta, operation: new_op }
            }
          }
        }
      }

      // -- Price Tab control -- //
      function changePriceTab(evt, tabPage) {
        // Update device list:
        refreshPriceActionList();
        generatePriceActionList(tabPage);

        // Get all elements with class="subtablinks" and remove the class "active"
        tablinks = document.getElementsByClassName("subtablinks");
        for (i = 0; i < tablinks.length; i++) {
          tablinks[i].className = tablinks[i].className.replace(" active", "");
        }

        // Show the current tab, and add an "active" class to the button that opened the tab
        if (evt) evt.currentTarget.className += " active";
      }

      function refreshModeLists() {
        for (var modeId = 0; modeId < modeList.length; modeId++) {
          var up_to_date_elements = {};
          // First remove devices that are no longer in use.
          for (var i = modeList[modeId].length-1; i >= 0 ; i--) {
            if (!(modeList[modeId][i].id in deviceList) || !deviceList[modeList[modeId][i].id].use) {
              modeList[modeId].splice(i, 1);
            } else {
              up_to_date_elements[modeList[modeId][i].id] = true;
            }
          }
          // Add new devices
          for (var key in deviceList) {
            if (deviceList[key].use && !(key in up_to_date_elements)) {
              // Adjust target to accomodate for both mode, water heaters and make room for price point deltas
              let targetTemp = deviceList[key].targetTemp;
              switch (modeId) {
                case 0: targetTemp = (targetTemp > 50) ? 65 : targetTemp; break; // Normal
                case 1: targetTemp = (targetTemp > 50) ? 65 : Math.round(targetTemp*0.8); break; // Night
                case 2: targetTemp = (targetTemp > 50) ? 30 : Math.round(targetTemp*0.25); break; // Away
                case 3: targetTemp = (targetTemp > 50) ? 65 : Math.round(targetTemp*0.5); break; // Custom
              }
              modeList[modeId].push({ id: key, operation: CONTROLLED, targetTemp: targetTemp });
            }
          }
        }
      }

      function refreshFrostList() {
        // Remove devices that are no longer in use.
        for (var deviceId in frostList) {
          if (!(deviceId in deviceList) || !deviceList[deviceId].use) {
            delete frostList[deviceId];
          }
        }
        // Add new devices
        for (var key in deviceList) {
          if (deviceList[key].use && !(key in frostList)) {
            frostList[key] = { minTemp: 5 }
          }
        }
      }

      function generateSupportedList() {
        let theList = '<table>';
        let allKeys = Object.keys(DEVICE_CMD);
        for (const devid in allKeys) {
          let isExperimental = DEVICE_CMD[allKeys[devid]].beta === true;
          theList += '<tr>';
          theList +=   '<td>' + allKeys[devid] + '</td>';
          theList +=   '<td><b>' + (isExperimental?onGoingText:'') + '</b></td>';
          theList += '</tr>'
        }
        theList += '</table>';
        return theList;
      }

      // -- Tab control -- //
      function changeTab(evt, tabPage, modeId = undefined) {
        var i, tabcontent, tablinks;

        // Update notifications in Welcome Page
        if (tabPage == 'welcomePage') {
          refreshTodoList();
        }

        // Update devicelist for Frost Page
        if (tabPage == 'frostPage') {
          refreshFrostList();
          generateFrostList();
        }

        // Update zone list for Zone Page
        if (tabPage == 'zonePage') {
          generateZoneList();
        }

        // Update price page in case it has not been updated before
        if (tabPage == 'pricePage') {
          changePriceTab(evt, 1);
        }
        
        // Refresh the mode lists
        if (tabPage == 'priorityPage') {
          refreshModeLists();
          generatePriorityList(modeId);
          currentModeTab = modeId;
        }

        // Get all elements with class="tabcontent" and hide them
        tabcontent = document.getElementsByClassName("tabcontent");
        for (i = 0; i < tabcontent.length; i++) {
          tabcontent[i].style.display = "none";
        }

        // Get all elements with class="tablinks" and remove the class "active"
        tablinks = document.getElementsByClassName("tablinks");
        for (i = 0; i < tablinks.length; i++) {
          tablinks[i].className = tablinks[i].className.replace(" active", "");
        }

        // Show the current tab, and add an "active" class to the button that opened the tab
        document.getElementById(tabPage).style.display = "block";
        if (evt) evt.currentTarget.className += " active";

        if (tabPage == 'logPage') {
          // Make the log text area fill the page
          diagLogElement.setAttribute('cols', (diagLogElement.parentElement.clientWidth-20) / 8);
          diagLogElement.style.height = (window.innerHeight - diagLogElement.offsetTop - 120) + 'px';
        }

        if (tabPage == 'helpSupportedPage') {
          document.getElementById('supportedDevicesList').innerHTML = generateSupportedList();
        }
      };

      // For testing only -
      // Remove when used on homey
      /*if (navigator.userAgent == "Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:101.0) Gecko/20100101 Firefox/101.0") {
        // Not homey, but debug mode
        maxPowerLoaded = true;
        deviceListLoaded = true;
        modeListLoaded = true;
        frostListLoaded = true;
        zoneListLoaded = true;
        operatingModeLoaded = true;
        priceModeLoaded = true;
        pricePointLoaded = true;
        priceActionListLoaded = true;
        errorMarginLoaded = true;
        controlTempLoaded = true;
        freeThresholdLoaded = true;
        safetyPowerLoaded = true;
        mainFuseLoaded = true;
        futurePriceOptionsLoaded = true;
        appConfigProgressLoaded = true;
        onHomeyReadyCompleted = true;
        setTimeout(function () {
          checkLoadingDone();
        }, 1 * 1000);
      }*/
    </script>
  </body>
</html>